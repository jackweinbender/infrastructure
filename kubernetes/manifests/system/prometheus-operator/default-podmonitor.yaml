# -----------------------------------------------------------------------------
# Default PodMonitor - Automatic Prometheus Scraping
# -----------------------------------------------------------------------------
# This PodMonitor automatically discovers and scrapes metrics from any pod
# in all namespaces that have the prometheus.io/scrape=true annotation.
#
# How to use this:
# 1. Add prometheus.io/scrape=true annotation to any pod you want monitored
# 2. Ensure your pod exposes metrics on a port named 'metrics' (or use prometheus.io/port)
# 3. Optionally customize the scraping behavior using these annotations:
#    - prometheus.io/scrape: "true"   (required - enables scraping)
#    - prometheus.io/port: "9090"     (optional - override port)
#    - prometheus.io/path: "/custom"  (optional - override path, default: /metrics)
#    - prometheus.io/scheme: "https"  (optional - override scheme, default: http)
# 4. Prometheus will automatically discover and scrape the annotated pods
# -----------------------------------------------------------------------------

apiVersion: monitoring.coreos.com/v1
kind: PodMonitor
metadata:
  name: default-podmonitor
  labels:
    prometheus: system
    team: sre
spec:
  namespaceSelector:
    any: true
  selector: {}  # Match all pods in the namespace
  podMetricsEndpoints:
    - port: metrics         # Named port to scrape (override via prometheus.io/port annotation)
      interval: 30s         # Scrape interval
      path: /metrics        # Default metrics path; can be overridden by annotation
      scheme: http          # Default scheme; can be overridden by annotation
      honorLabels: true     # Preserve original metric labels
      honorTimestamps: true # Preserve original timestamps (default is true; set for clarity)
      relabelings:
        # -----------------------------------------------------------------------------
        # The following relabelings configure Prometheus to dynamically discover pods and scrape them.
        # -----------------------------------------------------------------------------
        # Only scrape pods with prometheus.io/scrape: 'true' annotation
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
          action: keep
          regex: "true"
        # Allow prometheus.io/path annotation to override scrape path
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
          targetLabel: __metrics_path__
          regex: (.+)
          action: replace
        # Support prometheus.io/metrics_path annotation for backward compatibility.
        # If both prometheus.io/path and prometheus.io/metrics_path are present, prometheus.io/metrics_path will take precedence (for compatibility).
        # Prefer prometheus.io/path for new deployments.
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_metrics_path]
          targetLabel: __metrics_path__
          regex: (.+)
          action: replace
        # Allow prometheus.io/port annotation to override port
        - sourceLabels: [__meta_kubernetes_pod_ip, __meta_kubernetes_pod_annotation_prometheus_io_port]
          targetLabel: __address__
          # Prometheus automatically constructs __address__ from pod IP and `metrics` port.
          # If we override the port, we need to reconstruct __address__ by combining pod IP
          # and the overridden port.
          regex: ([^:]+)(?::\d+)?;(\d+)
          replacement: ${1}:${2}
          action: replace
        # Allow prometheus.io/scheme annotation to override scheme
        - sourceLabels: [__meta_kubernetes_pod_annotation_prometheus_io_scheme]
          targetLabel: __scheme__
          regex: (https?)
          action: replace
        # -----------------------------------------------------------------------------
        # Prevent scraping for invalid targets
        # -----------------------------------------------------------------------------
        # Drop targets if no valid address is set (requires host IP and port)
        - sourceLabels: [__address__]
          regex: .+:[0-9]+
          action: keep
        # Drop targets if no valid metrics path is set
        - sourceLabels: [__metrics_path__]
          regex: .+
          action: keep
        # -----------------------------------------------------------------------------
        # Additional relabelings to map standard Kubernetes labels to Prometheus metric labels
        # -----------------------------------------------------------------------------
        # Add namespace label
        - sourceLabels: [__meta_kubernetes_namespace]
          targetLabel: kubernetes_namespace
          action: replace
        # Add pod name label
        - sourceLabels: [__meta_kubernetes_pod_name]
          targetLabel: kubernetes_pod
          action: replace
        # Add controller name label (works for any controller type)
        - sourceLabels: [__meta_kubernetes_pod_controller_name]
          targetLabel: kubernetes_controller
          action: replace
        # Add controller kind label (Deployment, StatefulSet, DaemonSet, etc.)
        - sourceLabels: [__meta_kubernetes_pod_controller_kind]
          targetLabel: kubernetes_controller_kind
          action: replace
        # Add node name label
        - sourceLabels: [__meta_kubernetes_pod_node_name]
          targetLabel: kubernetes_node
          action: replace
        # Add container name label
        - sourceLabels: [__meta_kubernetes_pod_container_name]
          targetLabel: kubernetes_container
          action: replace
        # Map all app.kubernetes.io/* labels to metrics (safe, low-cardinality)
        # https://kubernetes.io/docs/concepts/overview/working-with-objects/common-labels/
        - action: labelmap
          regex: __meta_kubernetes_pod_label_app_kubernetes_io_(.+)
        # Map common stable labels, mostly for backward compatibility
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(app|version|component|env|environment|tier|team|k8s_app)
