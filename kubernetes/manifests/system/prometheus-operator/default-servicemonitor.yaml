# -----------------------------------------------------------------------------
# This ServiceMonitor resource configures Prometheus to scrape metrics from
# selected Kubernetes services. It requires target services to include
# Prometheus scrape annotations (e.g., prometheus.io/scrape: "true").
# -----------------------------------------------------------------------------
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: services-default-sm
spec:
  namespaceSelector:
    any: true
  selector:
    # Our default service monitor selects all services; use annotations to control scraping
    matchLabels: {}
  endpoints:
    - port: metrics         # Default port name to scrape; can be overridden by annotation
      interval: 30s         # Scrape interval
      path: /metrics        # Default metrics path; can be overridden by annotation
      scheme: http          # Default scheme; can be overridden by annotation
      honorLabels: true     # Preserve original metric labels
      honorTimestamps: true # Preserve original timestamps (default is true; set for clarity)
      relabelings:
        # Only scrape services with prometheus.io/scrape: 'true' annotation
        - sourceLabels: [__meta_kubernetes_service_annotation_prometheus_io_scrape]
          action: keep
          regex: "true"
        # Allow prometheus.io/path annotation to override scrape path
        - sourceLabels: [__meta_kubernetes_service_annotation_prometheus_io_path]
          targetLabel: __metrics_path__
          regex: (.+)
          action: replace
        # Support prometheus.io/metrics_path annotation as well
        - sourceLabels: [__meta_kubernetes_service_annotation_prometheus_io_metrics_path]
          targetLabel: __metrics_path__
          regex: (.+)
          action: replace
        # Allow prometheus.io/port annotation to override port in __address__
        - sourceLabels: [__meta_kubernetes_service_annotation_prometheus_io_port]
          targetLabel: __address__
          regex: (.+)
          action: replace
          replacement: $1
        # Allow prometheus.io/scheme annotation to override scheme
        - sourceLabels: [__meta_kubernetes_service_annotation_prometheus_io_scheme]
          targetLabel: __scheme__
          regex: (https?)
          action: replace
        # Drop targets if no valid port is set (prevents scraping misconfigured services)
        - sourceLabels: [__address__]
          regex: .+:[0-9]+
          action: keep
        # Drop targets if no valid metrics path is set
        - sourceLabels: [__metrics_path__]
          regex: .+
          action: keep
